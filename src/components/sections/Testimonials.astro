---
const testimonials = [
  {
    name: 'Alexis Deborde',
    rating: 5,
    text: 'Florent a installé les équipements de notre piscine (système pompe, contrôle pH, et système d\'électrolyse). Très professionnel et réactif.',
    date: 'Novembre 2025',
  },
  {
    name: 'Jérôme Jammes',
    rating: 5,
    text: 'Cabinet de kinébalnéothérapie à Ste Maxime en contrat d\'entretien avec Florent et sa société Aquacare. Très professionnel et réactif. À recommander.',
    date: 'Janvier 2026',
  },
  {
    name: 'Chloé Arnaud',
    rating: 5,
    text: 'Je recommande fortement Florent et Aquacare Service. Professionnels, réactifs, travail soigné et rapide. N\'hésitez pas, c\'est une valeur sûre.',
    date: 'Juillet 2025',
  },
  {
    name: 'Violaine Vigorelli',
    rating: 5,
    text: 'Florent est intervenu très rapidement avec beaucoup d\'efficacité et de sérieux lorsque le moteur de piscine a grillé cet été, merci encore\u00a0!',
    date: 'Janvier 2026',
  },
  {
    name: 'Cyril Marin Le Quellec',
    rating: 5,
    text: 'Excellent travail. Une piscine toujours impeccable.',
    date: 'Janvier 2026',
  },
  {
    name: 'Adrien Grege',
    rating: 5,
    text: 'Professionnel agréable, à l\'écoute et très réactif. Je recommande\u00a0!',
    date: 'Janvier 2026',
  },
  {
    name: 'Sylvain Fay',
    rating: 5,
    text: 'Professionnels, réactif, je recommande\u00a0! Merci.',
    date: 'Janvier 2026',
  },
  {
    name: 'Claude Richerme',
    rating: 5,
    text: 'Entretien nickel\u00a0! C\'est parfait\u00a0!',
    date: 'Janvier 2026',
  },
  {
    name: 'Marie Christine Sargeant',
    rating: 5,
    text: 'We highly recommend Aquacare Service which have looked after our swimming pool since 2017\u00a0!',
    date: 'Janvier 2026',
  },
];
---

<section class="testimonials" id="avis">
  <div class="testimonials__container container">
    <div class="testimonials__badge">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none">
        <path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z" fill="#FBBC04"/>
      </svg>
      <span class="testimonials__badge-score">5,0</span>
      <span class="testimonials__badge-source">sur Google ({testimonials.length} avis)</span>
    </div>

    <div class="testimonials__carousel">
      <div class="testimonials__track">
        {testimonials.map((t) => (
          <article class="testimonial-card">
            <div class="testimonial-card__stars">
              {Array.from({ length: t.rating }).map(() => (
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none">
                  <path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z" fill="#FBBC04"/>
                </svg>
              ))}
            </div>
            <blockquote class="testimonial-card__text">{t.text}</blockquote>
            <div class="testimonial-card__footer">
              <span class="testimonial-card__avatar">{t.name.charAt(0)}</span>
              <div>
                <span class="testimonial-card__name">{t.name}</span>
                <span class="testimonial-card__date">{t.date}</span>
              </div>
            </div>
          </article>
        ))}
      </div>

      <button class="testimonials__arrow testimonials__arrow--prev" type="button" aria-label="Avis précédent">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button class="testimonials__arrow testimonials__arrow--next" type="button" aria-label="Avis suivant">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="testimonials__dots">
      {testimonials.map((_, i) => (
        <button class:list={['testimonials__dot', { 'is-active': i === 0 }]} type="button" aria-label={`Aller à l'avis ${i + 1}`} />
      ))}
    </div>

    <p class="testimonials__ask">Si nous intervenons déjà chez vous, un retour d'expérience nous aide énormément.</p>
    <a href="https://www.google.com/search?newwindow=1&sca_esv=9687c9b822386596&rlz=1C1CHBF_frFR981FR981&hl=fr&si=AL3DRZEsmMGCryMMFSHJ3StBhOdZ2-6yYkXd_doETEE1OR-qOTMFrtxdos8IiqejSNh1WmPfnW1Jx5FTc3OroTyMZcBw9dpBIg2zhR7u1s-zWCSJ-qiybzB0lwxX2vl7fuB0b5jIAGOjRq6QWkzT1zNy_QOr-L3hVxDjav5Elmc-eHpLOHDyBZ2-FMrgaMP4mZMuRAs6iLe8kAWnu84DV8e3gZvDdfEanA%3D%3D&q=Aquacare+Service+-+entretien+piscine+haut+de+gamme+Golfe+de+Saint-Tropez+Avis&sa=X&ved=2ahUKEwjXld_LsM-SAxUVVaQEHZxnHBEQ0bkNegQIJRAD&biw=753&bih=944&dpr=1&sei=m2GLaa25HdCukdUP0dzxkAE" target="_blank" rel="noopener noreferrer" class="testimonials__add-review">
      + Ajouter un avis
    </a>
  </div>
</section>

<style>
  .testimonials {
    position: relative;
    padding-top: 0;
    padding-bottom: var(--section-gap);
    background: var(--color-white);
    overflow: hidden;
  }

  .testimonials__container {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--space-6);
  }

  .testimonials__container::before {
    content: '';
    display: block;
    width: 60px;
    height: 1px;
    background: var(--color-gray-200);
    margin-bottom: var(--space-2);
  }

  .testimonials__label {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--color-primary);
  }

  .testimonials__title {
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    font-weight: var(--font-bold);
    line-height: var(--leading-tight);
    color: var(--color-dark);
  }

  .testimonials__badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--color-white);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-full);
  }

  .testimonials__badge-score {
    font-size: var(--text-lg);
    font-weight: var(--font-bold);
    color: var(--color-dark);
  }

  .testimonials__badge-source {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
  }

  .testimonials__ask {
    font-size: var(--text-sm);
    color: var(--color-gray-500);
    max-width: 400px;
    line-height: var(--leading-relaxed);
  }

  .testimonials__add-review {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-primary);
    text-decoration: none;
    transition: opacity 0.2s ease;
  }

  .testimonials__add-review:hover {
    opacity: 0.7;
  }

  /* Carousel */
  .testimonials__carousel {
    --gap: 24px;
    --visible: 1;
    position: relative;
    width: 100%;
    max-width: 1100px;
    margin-top: var(--space-4);
  }

  @media (min-width: 768px) {
    .testimonials__carousel {
      --visible: 2;
    }
  }

  @media (min-width: 1024px) {
    .testimonials__carousel {
      --visible: 3;
    }
  }

  .testimonials__track {
    display: flex;
    gap: var(--gap);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding: 8px 4px;
  }

  .testimonials__track::-webkit-scrollbar {
    display: none;
  }

  .testimonial-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: var(--space-6);
    background: var(--color-white);
    border-radius: var(--radius-2xl);
    border: 1px solid var(--color-gray-200);
    text-align: left;
    min-width: calc((100% - var(--gap) * (var(--visible) - 1)) / var(--visible));
    max-width: calc((100% - var(--gap) * (var(--visible) - 1)) / var(--visible));
    scroll-snap-align: start;
    transition: transform 0.3s var(--ease-out-expo), box-shadow 0.3s ease;
  }

  .testimonial-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .testimonial-card__stars {
    display: flex;
    gap: 2px;
  }

  .testimonial-card__text {
    font-size: var(--text-base);
    color: var(--color-gray-700);
    line-height: var(--leading-relaxed);
    flex-grow: 1;
  }

  .testimonial-card__footer {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-gray-100);
  }

  .testimonial-card__avatar {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-primary-soft);
    color: var(--color-primary);
    font-weight: var(--font-bold);
    font-size: var(--text-base);
    border-radius: 50%;
    flex-shrink: 0;
  }

  .testimonial-card__name {
    display: block;
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--color-dark);
  }

  .testimonial-card__date {
    display: block;
    font-size: 12px;
    color: var(--color-gray-500);
  }

  /* Arrows */
  .testimonials__arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-white);
    border: 1px solid var(--color-gray-200);
    border-radius: 50%;
    color: var(--color-dark);
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    z-index: 2;
  }

  .testimonials__arrow:hover {
    background: var(--color-primary);
    color: var(--color-white);
    border-color: var(--color-primary);
  }

  .testimonials__arrow:disabled {
    opacity: 0.3;
    cursor: default;
    pointer-events: none;
  }

  .testimonials__arrow--prev {
    left: -8px;
  }

  .testimonials__arrow--next {
    right: -8px;
  }

  @media (max-width: 767px) {
    .testimonials__arrow {
      display: none;
    }
  }

  /* Dots */
  .testimonials__dots {
    display: flex;
    gap: var(--space-2);
    justify-content: center;
  }

  .testimonials__dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: var(--color-gray-300);
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
  }

  .testimonials__dot:global(.is-active) {
    background: var(--color-primary);
    transform: scale(1.3);
  }
</style>

<script>
  const track = document.querySelector('.testimonials__track');
  const cards = document.querySelectorAll('.testimonial-card');
  const dots = document.querySelectorAll('.testimonials__dot');
  const prevBtn = document.querySelector('.testimonials__arrow--prev');
  const nextBtn = document.querySelector('.testimonials__arrow--next');

  if (track && cards.length) {
    let current = 0;

    function getStep() {
      // Width of one card + gap
      const gap = parseFloat(getComputedStyle(track).gap) || 24;
      return cards[0].offsetWidth + gap;
    }

    function getMaxIndex() {
      const visible = Math.round(track.offsetWidth / cards[0].offsetWidth);
      return Math.max(0, cards.length - visible);
    }

    function update() {
      dots.forEach((d, i) => d.classList.toggle('is-active', i === current));
      if (prevBtn) prevBtn.disabled = current <= 0;
      if (nextBtn) nextBtn.disabled = current >= getMaxIndex();
    }

    function goTo(index) {
      current = Math.max(0, Math.min(index, getMaxIndex()));
      track.scrollTo({ left: current * getStep(), behavior: 'smooth' });
      update();
    }

    if (prevBtn) prevBtn.addEventListener('click', () => goTo(current - 1));
    if (nextBtn) nextBtn.addEventListener('click', () => goTo(current + 1));
    dots.forEach((dot, i) => dot.addEventListener('click', () => goTo(i)));

    // Sync on swipe / manual scroll
    let timer;
    track.addEventListener('scroll', () => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        const step = getStep();
        if (step > 0) {
          current = Math.round(track.scrollLeft / step);
          update();
        }
      }, 100);
    });

    update();
  }
</script>
